<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polymarket HFT Bot</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --success-color: #10b981;
            --danger-color: #ef4444;
        }
        body {
            background-color: var(--bg-color);
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 2rem;
        }
        .navbar {
            background: linear-gradient(135deg, #1a1c20 0%, #2c3e50 100%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 0.8rem 0;
            margin-bottom: 1.5rem !important;
        }
        .navbar-brand {
            font-weight: 700;
            letter-spacing: -0.5px;
            font-size: 1.1rem;
        }
        .card {
            background: var(--card-bg);
            border: none;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
        }
        .card-header {
            background-color: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-card-body {
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stat-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            opacity: 0.08;
            color: var(--text-primary);
        }
        /* Table Styling */
        .table-responsive {
            border-radius: 0 0 16px 16px;
        }
        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #edf2f7;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.75rem 1rem;
            white-space: nowrap;
        }
        .table tbody td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.02);
        }
        /* Badges & Colors */
        .badge {
            padding: 0.5em 0.8em;
            border-radius: 6px;
            font-weight: 500;
        }
        .badge-mode {
            font-size: 0.8rem;
            padding: 0.4em 0.8em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .text-profit { color: var(--success-color) !important; }
        .text-loss { color: var(--danger-color) !important; }
        
        #equityChart { max-height: 320px; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .container { padding-left: 12px; padding-right: 12px; }
            .navbar-brand { font-size: 1rem; }
            .stat-value { font-size: 1.3rem; }
            .card-header { padding: 0.8rem 1rem; }
            .table thead th, .table tbody td { padding: 0.6rem 0.8rem; }
            
            /* Compact tables on mobile */
            .table-mobile-compact thead th, 
            .table-mobile-compact tbody td {
                padding: 0.5rem 0.4rem;
                font-size: 0.8rem;
            }
            #equityChart { max-height: 240px; }
            
            /* Ensure cards stretch properly in grid */
            .row.g-3 > div {
                display: flex;
            }
            .card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="bi bi-robot text-light me-2 fs-5"></i>
                <span class="navbar-brand mb-0 h1">Polymarket HFT</span>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-secondary me-2 d-none d-sm-inline" id="last-update" style="font-weight: 400; opacity: 0.9;">等待更新...</span>
                <span class="badge bg-primary badge-mode" id="mode-badge">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Grid: 2 columns on mobile, 4 on desktop -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-lg-3">
                <div class="card">
                    <div class="stat-card-body">
                        <div class="stat-label">总权益 (Equity)</div>
                        <div class="stat-value" id="equity-val">--</div>
                        <i class="bi bi-graph-up stat-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card">
                    <div class="stat-card-body">
                        <div class="stat-label">可用现金 (Cash)</div>
                        <div class="stat-value" id="cash-val">--</div>
                        <i class="bi bi-wallet2 stat-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card">
                    <div class="stat-card-body">
                        <div class="stat-label">已实现盈亏 (PnL)</div>
                        <div class="stat-value" id="pnl-val">--</div>
                        <i class="bi bi-piggy-bank stat-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card">
                    <div class="stat-card-body">
                        <div class="stat-label">持仓数 (Pos)</div>
                        <div class="stat-value" id="pos-count-card">0</div>
                        <i class="bi bi-layers stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-activity me-2 text-primary"></i>
                            资金曲线 (Equity Curve)
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="equityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <i class="bi bi-list-check me-2 text-primary"></i>
                    <span>活跃持仓详情</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-mobile-compact mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 25%">市场</th>
                                <th class="d-none d-md-table-cell">资产</th>
                                <th>预测</th>
                                <th class="d-none d-md-table-cell">持仓</th>
                                <th class="d-none d-md-table-cell">均价</th>
                                <th>市值</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <i class="bi bi-clock-history me-2 text-primary"></i>
                    <span>历史交易记录</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-mobile-compact mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width: 80px;">时间</th>
                                <th>类型</th>
                                <th style="min-width: 120px;">市场</th>
                                <th class="d-none d-md-table-cell">资产</th>
                                <th class="d-none d-md-table-cell">方向</th>
                                <th>金额</th>
                                <th class="d-none d-md-table-cell">价格</th>
                                <th class="d-none d-md-table-cell">数量</th>
                                <th>PnL</th>
                                <th class="d-none d-md-table-cell">费用</th>
                                <th>结果</th>
                                <th class="d-none d-md-table-cell" style="min-width: 100px;">详情</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let equityChart = null;

        function initChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '总权益 (USD)',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.05)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#2c3e50',
                            bodyColor: '#2c3e50',
                            borderColor: '#e9ecef',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#f0f0f0'
                            },
                            ticks: {
                                font: { family: "'Inter', sans-serif", size: 10 }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function formatMoney(amount) {
            return '$' + parseFloat(amount).toFixed(2);
        }

        function formatMaybeMoney(amount) {
            if (amount === null || amount === undefined || amount === '') return '--';
            const x = parseFloat(amount);
            if (Number.isNaN(x)) return '--';
            return '$' + x.toFixed(2);
        }

        function formatMaybeNumber(amount, digits) {
            if (amount === null || amount === undefined || amount === '') return '--';
            const x = parseFloat(amount);
            if (Number.isNaN(x)) return '--';
            return x.toFixed(digits);
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                const modeMap = { 'live': '实盘', 'paper': '模拟' };
                const modeText = modeMap[data.mode] || data.mode;
                const badge = document.getElementById('mode-badge');
                badge.innerText = modeText;
                badge.className = 'badge badge-mode ' + (data.mode === 'live' ? 'bg-danger' : 'bg-success');

                document.getElementById('cash-val').innerText = formatMoney(data.cash);
                document.getElementById('equity-val').innerText = formatMoney(data.equity);

                const pnl = parseFloat(data.pnl);
                const pnlEl = document.getElementById('pnl-val');
                pnlEl.innerText = (pnl >= 0 ? '+' : '') + formatMoney(pnl);
                pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'text-profit' : 'text-loss');

                document.getElementById('pos-count-card').innerText = data.positions.length;
                document.getElementById('last-update').innerText = new Date(data.ts).toLocaleTimeString();

                if (data.history && data.history.length > 0) {
                    const labels = data.history.map(h => new Date(h.ts).toLocaleTimeString());
                    const values = data.history.map(h => h.value);

                    equityChart.data.labels = labels;
                    equityChart.data.datasets[0].data = values;
                    equityChart.update('none');
                }

                const tbody = document.getElementById('positions-body');
                tbody.innerHTML = '';

                if (data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><i class="bi bi-inbox me-2"></i>当前无活跃持仓</td></tr>';
                } else {
                    data.positions.forEach(pos => {
                        const tr = document.createElement('tr');
                        const link = pos.link && pos.link !== '#' ? pos.link : 'javascript:void(0)';
                        const target = pos.link && pos.link !== '#' ? 'target="_blank"' : '';

                        tr.innerHTML = `
                            <td>
                                <a href="${link}" ${target} class="text-decoration-none fw-bold text-dark text-truncate d-inline-block" style="max-width: 180px;" title="${pos.market}">
                                    ${pos.market || '未知市场'}
                                </a>
                            </td>
                            <td class="d-none d-md-table-cell"><span class="badge bg-light text-dark border">${pos.symbol}</span></td>
                            <td>
                                <span class="badge ${pos.outcome === 'Yes' ? 'bg-success' : 'bg-secondary'}">
                                    ${pos.outcome}
                                </span>
                            </td>
                            <td class="font-monospace text-muted d-none d-md-table-cell">${parseFloat(pos.size).toFixed(2)}</td>
                            <td class="font-monospace text-muted d-none d-md-table-cell">$${parseFloat(pos.entry_price).toFixed(3)}</td>
                            <td class="fw-bold">$${parseFloat(pos.value).toFixed(2)}</td>
                            <td class="text-end">
                                <a href="${link}" ${target} class="btn btn-sm btn-outline-primary rounded-pill px-3 py-0" style="font-size: 0.8rem;">查看</a>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                const tradesBody = document.getElementById('trades-body');
                if (tradesBody) {
                    tradesBody.innerHTML = '';
                    const trades = data.recent_trades || [];
                    if (!Array.isArray(trades) || trades.length === 0) {
                        tradesBody.innerHTML = '<tr><td colspan="12" class="text-center py-5 text-muted"><i class="bi bi-clock-history me-2"></i>暂无交易记录</td></tr>';
                    } else {
                        trades.forEach(t => {
                            const tr = document.createElement('tr');
                            const link = t.link && t.link !== '#' ? t.link : 'javascript:void(0)';
                            const target = t.link && t.link !== '#' ? 'target="_blank"' : '';
                            const tsText = t.ts ? new Date(t.ts).toLocaleTimeString() : '--'; // Use TimeString for brevity on mobile
                            const pnl = (t.pnl === null || t.pnl === undefined || t.pnl === '') ? null : parseFloat(t.pnl);
                            const pnlText = pnl === null || Number.isNaN(pnl) ? '--' : ((pnl >= 0 ? '+' : '') + formatMaybeMoney(pnl));
                            const pnlCls = pnl === null || Number.isNaN(pnl) ? '' : (pnl >= 0 ? 'text-profit' : 'text-loss');
                            const result = (t.result || '').toLowerCase();
                            const resultBadge = result === 'win'
                                ? '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">WIN</span>'
                                : (result === 'lose' ? '<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">LOSS</span>' : '');

                            // Type badge mapping
                            let typeBadge = '';
                            if (t.type === 'buy') typeBadge = '<span class="badge bg-primary bg-opacity-10 text-primary">开仓</span>';
                            else if (t.type === 'settle') typeBadge = '<span class="badge bg-warning bg-opacity-10 text-warning">结算</span>';
                            else typeBadge = `<span class="badge bg-secondary bg-opacity-10 text-secondary">${t.type}</span>`;

                            tr.innerHTML = `
                                <td class="font-monospace text-muted" style="font-size: 0.85rem;">${tsText}</td>
                                <td>${typeBadge}</td>
                                <td>
                                    <a href="${link}" ${target} class="text-decoration-none fw-bold text-dark text-truncate d-inline-block" style="max-width: 150px;" title="${t.market || ''}">
                                        ${t.market || '--'}
                                    </a>
                                </td>
                                <td class="d-none d-md-table-cell"><span class="badge bg-light text-dark border">${t.symbol || '--'}</span></td>
                                <td class="d-none d-md-table-cell"><span class="badge bg-secondary bg-opacity-25 text-dark">${t.outcome || '--'}</span></td>
                                <td class="font-monospace">${formatMaybeMoney(t.notional)}</td>
                                <td class="font-monospace text-muted d-none d-md-table-cell">${t.price === null || t.price === undefined ? '--' : ('$' + formatMaybeNumber(t.price, 3))}</td>
                                <td class="font-monospace text-muted d-none d-md-table-cell">${formatMaybeNumber(t.size, 4)}</td>
                                <td class="fw-bold ${pnlCls}">${pnlText}</td>
                                <td class="font-monospace text-muted small d-none d-md-table-cell">${formatMaybeMoney(t.fee)}</td>
                                <td>${resultBadge}</td>
                                <td class="text-truncate text-muted small d-none d-md-table-cell" style="max-width: 120px;" title="${t.detail || ''}">${t.detail || ''}</td>
                            `;
                            tradesBody.appendChild(tr);
                        });
                    }
                }
            } catch (e) {
                console.error("Failed to fetch stats", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            updateStats();
            setInterval(updateStats, 3000);
        });
    </script>
</body>
</html>
